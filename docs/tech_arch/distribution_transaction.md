# 分布式事务

## 产生分布式事务的原因

**分布式事务归根还是数据的一个一致性问题，和Raft要解决的同一个数据的一致性不同；分布式事务要解决在一个事务中，数据的变更需要一致，要么全提交、要么全回滚，ACID**

**基于不同的架构视角，产生分布式事务的原因是不一样的**

- 在单应用架构下，系统为了提升性能和未来的高可扩展，会进行分库或者分表；而进行`分库`之后，由于事务操作可能不在一个数据库中完成，从而导致单连接的事务失效，导致数据不一致；而`分表`操作由于还是在同一个数据库内完成，基本不涉及`分布式事务`问题

- 在微服务架构下，由于一次完整的业务流程会调用多个微服务，数据会在多个上下游系统中流转，各个系统数据库资源独立；任何一步异常都会导致事务的数据结果不一致

![分布式事务_产生原因](./imgs/分布式事务_产生原因.png)

----

## BASE理论

**- Basically Available(基本可用):** 在分布式集群当中，某一个服务节点宕机，或者数据在复制的过程中又部分不可用，不影响整个系统的可用性（因为可以基于后续的流程进行补偿）。

**- Soft State(软状态):** 软状态理解为一个中间状态，允许数据在节点集群间操作的过程中，存在一个延时；但是这个中间状态，最后一定会转为一个终态。

**- Eventual Consistency(最终一致性):** 数据在分布式集群节点间的同步操作存在延时，这与ACID原则相反，在中间的一段时间内，数据是不一致的；但是经过一段时间后，分布式集群节点间的数据拷贝可以达到最终一致性。

----

## 基于本地消息表实现分布式事务

本地消息表的核心是将需要分布式执行的事务流程，通过消息日志的方式进行异步执行。本地消息表的方案最早由Ebay提出，是BASE理论的实现，也是最终一致性的表现。因为在一个完整的事务流程中，记录都存在一个中间状态，待事务完成后，流转到最终状态。

以支付账户与会计系统为例，整体流程表述：账户系统完成账户资金划转后，调用会计系统生成会计记账分录。此时需要明确：如果在账户资金划转的过程中，调用会计系统，一定会产生分布式事务问题。

![分布式事务_本地事务表](./imgs/分布式事务_本地事务表.png)

### 实现思路

**本地事务消息表设计：**

| 字段 | 描述 |
| ---- | ---- |
| t_id | 自增主键 |
| t_msg_id | 消息id，在业务系统内唯一，用来实现幂等和防重 |
| t_msg_payload | 消息内容 |
| t_state | 消息状态 |
| t_retrycount | 重试次数 |

上述的表设计抛砖引玉，实际应用时需要根据实际情况进行调整。但是，该表已经具备`事务消息表`的最基本要素。

**具体流程说明：**
- 账户系统接收上游系统请求，开启事务Txn_1
  - 完成本地事务流程，更新数据库
  - 组装事务消息记录表信息（状态：发送中、重试次数：0），生成消息的唯一Id(雪花算法、自增序列、UUID)
  - 提交事务Txn_1
- 账户系统`消息Push任务`定时捞取`事务消息表`中，状态为`发送中`&&重试次数<`最大重试次数`的记录
  - 组装`msgId`和`msgPayload`消息，同步发送到消息中间件
  - 收到Broker的Ack成功的响应后，更新记录状态为`发送成功`
  - 如果Push消息失败，则将`重试次数 + 1`，等待下次任务重试
- 会计系统接收MQ的消息，开启事务Txn_2
  - 将消息插入到一张`消息记录表`中，其中`上游系统id` + `msgId`作为幂等键，如果是重复消息，忽略处理
  - 执行会计系统业务逻辑，生成会计分录
  - 更新消息记录状态为`处理成功`

经过前面的步骤，整个业务就已经完成了。但这是在理想的状态下，中间的步骤没有任何的异常，但实际情况里，生产者、MQ、消费者都会有失败的情况。下面我们就讨论一下，面对异常场景应该如何处理。

### 问题与方案

**问题1：上游系统事务执行失败**

- 根据事务的ACID特性，我们需要保证本地业务和插入事务消息记录表的逻辑在一个本地事务中完成。

- 在简单系统中，一个微服务一般只对应一个数据库，这基本可以保证两个步骤在同一个事务中完成。

- 如果涉及到分库的系统，我们需要在每一个分库中建立一张`本地事务消息表`；因为在系统完成分库后，我们的一个原则是：要将事务尽可能的在同一个库中完成。但是，生成的`msgId`必须在系统内全局唯一，这需要有一定的`分布式ID`机制保证

**问题2：上游系统消息Push任务执行失败**

### 总结

----

## 基于TCC方案实现分布式事务

## 基于对账实现最终一致性

**参考：**
> ebay基于本地消息表实现分布式事务的完整方案：https://queue.acm.org/detail.cfm?id=1394128。