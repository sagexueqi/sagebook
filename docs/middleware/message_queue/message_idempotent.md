# Message Idempotent(消息幂等)

## 什么是消息幂等

当出现消费者对某条消息重复消费的情况时，重复消费的结果与消费一次的结果是相同的，并且多次消费并未对业务系统产生任何负面影响，那么这个消费者的处理过程就是幂等的。

例如，在支付场景下，消费者消费一笔扣款消息，对账户进行扣款操作，扣款金额为100元。但是由于网络或其他系统问题，上层支付引擎重复投递扣款消息。消费者重复消费了该扣款消息，但最终的业务结果是只扣款一次，扣费100元，且用户的扣款记录中对应的订单只有一条扣款流水，不会多次扣除。这说明整个消费过程实现了消费幂等。

----

## 产生幂等问题的场景

**发送端消息重复投递**

- 由于网络抖动等原因发送失败进行重试操作时，生产者意识到消息发送失败并发起重试时，消费者后续有可能收到两条重复的消息
- 生产者异步发送时，Producer Client配置了重试
- 持久化消息定时任务没有乐观锁更新中间态机制，导致记录被重复捞取，重复投递

**Broker端消息重复投递**

- 消息队列内部机制，会尽最大努力投递；为了保证消息至少被消费一次，消息队列在网络恢复后再次尝试投递之前已被处理过的消息，消费者后续会收到两条内容相同并且Message ID也相同的消息
- 消费者端自动提交offset，但是由于各种异常原因提交失败（例如逻辑与拉取同步，逻辑异常没有提交offset；异步提交offset，但是在提交线程执行工作前宕机等）；导致消费者端恢复时，获取的仍是之前的offset，导致消息重复消费

----

## 解决方案