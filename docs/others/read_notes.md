# 读书笔记

## 《微服务设计》

### 1. 关于【4.12 按引用访问的思考】

订单服务与邮件服务的关系，书中描述‘订单状态更新后，订单服务将客户的姓名、订单详情、邮件地址等发送到邮件服务。但是邮件服务有可能会将这个请求放入队列，然后在将来的某个时间从队列中取出来。在这个过程中，客户和订单的信息可能会发生变化。’

针对这一场景，书中给出的方案是‘仅仅发送客户资源和订单资源的URI，然后等邮件服务就绪时再回过头来查询这些信息’。这个方案的好处显而易见：时刻可以保持推送的客户信息和订单信息是最新的，但是这样就形成了一个双向依赖，不太符合架构设计中自顶向下依赖的原则。

我的想法：
  - 在订单领域应该再抽象出一个订单消息服务，邮件推送服务作为底层基础服务，职责应该单一，更多的应该关注Push性能、风控、安全、模板配置方面
  - 订单的状态流转应符合状态机的流转方向，用户应该是顺序的收到订单状态变更的邮件。在订单服务中，订单邮件消息应该按照OrderId的维度，利用Message中间件Queue或分区的消息顺序特性推送到订单消息服务中
  - 订单消息服务同样按照OrderId维度顺序推送消息（客户资源信息、参数模板信息）到邮件服务。再每次Push前，可以通过调用邮件服务，确认邮件服务已成功接收后，再Push下一个状态的数据
  - 邮件服务可以依赖客户服务，一般来说，在业务执行的过程中，用户是有可能修改邮箱资源信息的。而且，邮件服务只接收客户资源信息，也可以避免将过多的业务逻辑对外暴露（使用方不需要关心我需要什么客户资源参数用于推送邮件）