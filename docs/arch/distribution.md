# 分布式系统

## CAP理论
- Consistency 一致性，在分布式系统中的所有数据备份，在同一时刻是否同样的值
- Availability 可用性，只要收到用户的请求，服务器就必须给出回应
- Partition tolerance 分区容错性，以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择

其中`分区容错性`是一定可以实现的，例如我们的服务有两个集群，其中一个挂掉并不影响整个系统对外提供服务。

但是CAP定理是理论上的，它没有考虑网络传输的延迟。所以，即使是保证CP的场景，也是一种`最终一致性`。

----

## RAFT协议

**参考：**
> RAFT论文中文版：https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md

----

## 分布式锁方案

## 分布式ID生成方案

## 分布式事务方案

----

## 注册中心与配置中心

### 注册中心选型

**CP模型：Zookeeper**

- ZAB协议是CP方案，可以保证注册中心数据的强一致性
- 引入较为复杂的中间件，2n+1个节点的zk集群，一旦发生n个节点不可用，会导致zk集群不可用，进而会导致整个注册中心无法向外提供服务

> Q：为什么n个节点不可用，会导致整个集群不可用？
>
> A: 根据ZAB或RAFT等分布式一致性协议的特性，数据(log)需要一半以上的follower节点accept后才可以commit。如果n个节点挂掉后，集群中无法有一半以上的节点accept，导致leader的数据始终无法commit

**AP模型：Eureka**

- AP方案，保证注册集群的高可用性。Eureka中各个节点互相独立，通过心跳彼此通信和同步数据，无Leader概念，也就没有强一致性的概念，实现简单
- 缺点明显，各个Node的节点会有不一致的情况，但是作为RPC注册中心的话，可以通过本地Cache备份服务表、retry、robbin等方式保证服务调用的可用性

**两种技术选型的思考**

- 如果单看RPC服务注册中心的维度，我们可能无需保证服务注册信息的强一致性;服务注册信息属于经常性变化的数据（服务上线、下线均会变更），且临时性较强
- 基于CP方案，虽然保证了注册中心数据的一致性，但是可用性降低；由于RPC服务有频繁的发布特点，会导致SLA降低
- 基于AP方案，虽然数据会有不一致，但是RPC Consumer可以通过本地缓存、retry、robbin的方式，尽最大可能完成RPC调用；对于频繁发布部署的RPC服务，只要注册中心集群还可用，注册到某一个Node上之后，待集群故障节点全部恢复，数据即可完成`最终一致性`同步

### 配置中心选型