# 分布式系统

## CAP理论
- Consistency 一致性，在分布式系统中的所有数据备份，在同一时刻是否同样的值
- Availability 可用性，只要收到用户的请求，服务器就必须给出回应
- Partition tolerance 分区容错性，以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择

其中`分区容错性`是一定可以实现的，例如我们的服务有两个集群，其中一个挂掉并不影响整个系统对外提供服务。

但是CAP定理是理论上的，它没有考虑网络传输的延迟。所以，即使是保证CP的场景，也是一种`最终一致性`。

----

## 分布式一致性协议

**Zookeeper中的ZAB是RAFT协议的改进:**

- 竞选Leader: 
  - 各个节点分别对自己投票，之后互相投票；
  - 如果仍然票数一直，重新投票至有人票数过半；
  - 这样说明了，zk要工作在2n+1个节点的原因(n是宕机节点)，如果是2n个节点，有可能会永远没有大于半数的投票
- 服务提供: 
  - Leader节点对外提供读写服务，接收写入请求后，同步至各个Flower节点；
  - 超过半数节点确认之后，Leader节点提交返回成功。
  - 这也说明ZK不适合做注册中心的原因，注册中心的高可用性需求是大于强一致性需求，保证强一致的前提一定是牺牲性能
- 心跳机制: 如果Flower超时没有收到Leader的心跳，要重新选举，此时可能会出现脑裂问题
- 脑裂问题: 由于网络问题，Flower长时间没有接收到Leader的心跳导致超时后，重新选举新的Leader；待网络恢复后，造成此时集群一分为二，同时出现两个Leader的情况
  - 拒绝旧id的Leader的同步写入请求，Leader降级为Flower
  - 增加阈值，即使Leader心跳超时，也要有一个容错时间，让Leader完全shutdown

**Nacos一致性算法distro分析：**

----

## 分布式锁方案

## 分布式ID生成方案

## 分布式事务方案